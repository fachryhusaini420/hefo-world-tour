<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hefo World Tour — Reponator Driver · Racing NFT & Progression</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0c0e;
      --bg-panel: #111418;
      --bg-card: #181c22;
      --border: #2a3038;
      --border-soft: #1e2329;
      --race: #e63946;
      --race-dim: #c92a37;
      --gold: #f4d35e;
      --gold-dim: #d4b84a;
      --track: #457b9d;
      --track-dim: #3a6a88;
      --text: #e8eaed;
      --text-dim: #8a9099;
      --glow: rgba(230, 57, 70, 0.12);
      --radius: 10px;
      --radius-sm: 6px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(230, 57, 70, 0.06), transparent);
    }
    .app { max-width: 940px; margin: 0 auto; padding: 1.25rem 1rem; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem 0 1.25rem;
      border-bottom: 1px solid var(--border-soft);
      margin-bottom: 1.25rem;
    }
    .logo { font-weight: 700; font-size: 1.65rem; color: var(--race); letter-spacing: 0.04em; }
    .tagline { font-size: 0.78rem; color: var(--text-dim); margin-top: 0.2rem; }
    .header-right { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .wallet-addr { font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; color: var(--gold); max-width: 130px; overflow: hidden; text-overflow: ellipsis; }
    .contract-in { width: 200px; padding: 0.45rem 0.6rem; font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-sm); }
    .btn { font-family: 'Rajdhani', sans-serif; font-weight: 600; padding: 0.5rem 0.95rem; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.9rem; }
    .btn:hover { border-color: var(--race-dim); color: var(--race); }
    .btn.primary { background: var(--race-dim); border-color: var(--race); color: #fff; }
    .btn.primary:hover { box-shadow: 0 0 16px var(--glow); }
    .btn.gold { border-color: var(--gold-dim); color: var(--gold); }
    .btn.small { padding: 0.35rem 0.65rem; font-size: 0.85rem; }

    .hero {
      text-align: center;
      padding: 1.75rem 1rem;
      background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius);
      margin-bottom: 1.25rem;
    }
    .hero h1 { font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.4rem; }
    .hero p { color: var(--text-dim); font-size: 0.92rem; }

    .stats-row { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; }
    .stat-card { flex: 1; min-width: 130px; padding: 0.85rem; background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius-sm); }
    .stat-card .label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
    .stat-card .value { font-family: 'Share Tech Mono', monospace; font-size: 1.05rem; color: var(--race); }
    .stat-card .value.gold { color: var(--gold); }

    .tabs { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 1rem; }
    .tab { padding: 0.5rem 0.95rem; background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.88rem; font-weight: 500; }
    .tab:hover { color: var(--text); }
    .tab.active { border-color: var(--race-dim); color: var(--race); background: var(--glow); }

    .panel { display: none; }
    .panel.visible { display: block; }

    .card { background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius); padding: 1.15rem; margin-bottom: 1rem; }
    .card h3 { font-size: 1rem; margin-bottom: 0.65rem; color: var(--race-dim); font-weight: 600; }
    .card h4 { font-size: 0.88rem; margin: 0.9rem 0 0.45rem; color: var(--text-dim); font-weight: 500; }
    label { display: block; font-size: 0.78rem; color: var(--text-dim); margin-bottom: 0.25rem; }
    .input, select { width: 100%; padding: 0.5rem 0.65rem; font-family: 'Share Tech Mono', monospace; font-size: 0.84rem; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: var(--radius-sm); margin-bottom: 0.5rem; }
    .input:focus, select:focus { outline: none; border-color: var(--race-dim); }
    .actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.7rem; }
    .msg { padding: 0.55rem; border-radius: var(--radius-sm); margin-top: 0.5rem; font-size: 0.84rem; }
    .msg.ok { background: rgba(68, 123, 157, 0.15); border: 1px solid var(--track); color: var(--track); }
    .msg.err { background: rgba(230, 57, 70, 0.12); border: 1px solid var(--race); color: var(--race-dim); }
    .msg.info { background: var(--glow); border: 1px solid var(--race-dim); color: var(--race); }

    .car-list { list-style: none; }
    .car-list li { border: 1px solid var(--border-soft); border-radius: var(--radius-sm); padding: 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
    .car-list li:hover { background: var(--bg-panel); }
    .car-list .id { font-family: 'Share Tech Mono', monospace; color: var(--gold); }
    .car-list .traits { color: var(--text-dim); font-size: 0.8rem; }
    .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .leaderboard-table th, .leaderboard-table td { padding: 0.5rem 0.6rem; text-align: left; border-bottom: 1px solid var(--border-soft); }
    .leaderboard-table th { color: var(--text-dim); font-weight: 500; }
    .leaderboard-table .mono { font-family: 'Share Tech Mono', monospace; }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.6rem; font-size: 0.82rem; }
    .config-item { padding: 0.5rem; background: var(--bg); border-radius: var(--radius-sm); }
    .config-item .k { color: var(--text-dim); font-size: 0.75rem; }
    .config-item .v { font-family: 'Share Tech Mono', monospace; word-break: break-all; font-size: 0.78rem; }

    .footer-note { text-align: center; font-size: 0.75rem; color: var(--text-dim); margin-top: 1.5rem; padding-top: 0.9rem; border-top: 1px solid var(--border-soft); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="logo">Hefo World Tour</div>
        <p class="tagline">Reponator Driver · Racing car NFT · NFT-gated progression</p>
      </div>
      <div class="header-right">
        <span id="wallet-addr" class="wallet-addr">Not connected</span>
        <input type="text" id="contract-address" class="contract-in" placeholder="Contract 0x..." />
        <button type="button" id="btn-connect" class="btn primary">Connect</button>
      </div>
    </header>

    <section class="hero">
      <h1>Race. Mint. Progress.</h1>
      <p>Mint racing car NFTs by chassis and engine tier. Unlock stages and checkpoints by holding qualifying cars. Compete on the leaderboard. Hefo World Tour is powered by the Reponator Driver contract.</p>
    </section>

    <div class="stats-row">
      <div class="stat-card"><div class="label">Total minted</div><div class="value" id="stat-minted">—</div></div>
      <div class="stat-card"><div class="label">My cars</div><div class="value gold" id="stat-my-cars">—</div></div>
      <div class="stat-card"><div class="label">Stages unlocked</div><div class="value" id="stat-stages">—</div></div>
      <div class="stat-card"><div class="label">Status</div><div class="value" id="stat-paused">—</div></div>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" data-tab="mint">Mint car</button>
      <button type="button" class="tab" data-tab="my-cars">My cars</button>
      <button type="button" class="tab" data-tab="progression">Progression</button>
      <button type="button" class="tab" data-tab="leaderboard">Leaderboard</button>
      <button type="button" class="tab" data-tab="roles">Roles (Pit Boss / Director)</button>
      <button type="button" class="tab" data-tab="config">Config</button>
    </div>

    <div id="panel-mint" class="panel visible">
      <div class="card">
        <h3>Mint racing car</h3>
        <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.8rem;">Chassis type 0–31, engine tier 0–7. Price depends on chassis. Pay in ETH.</p>
        <label>Chassis type (0–31)</label>
        <input type="number" id="mint-chassis" class="input" min="0" max="31" value="0" />
        <label>Engine tier (0–7)</label>
        <input type="number" id="mint-tier" class="input" min="0" max="7" value="1" />
        <label>Mint price (wei) — will be shown after contract load</label>
        <input type="text" id="mint-price-display" class="input" placeholder="—" readonly />
        <div class="actions">
          <button type="button" id="btn-mint" class="btn primary">Mint car</button>
        </div>
        <div id="mint-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Batch mint</h3>
        <label>Chassis types (comma-separated, e.g. 0,1,2)</label>
        <input type="text" id="batch-chassis" class="input" placeholder="0,1,2" />
        <label>Engine tiers (comma-separated, e.g. 1,2,1)</label>
        <input type="text" id="batch-tier" class="input" placeholder="1,2,1" />
        <button type="button" id="btn-batch-mint" class="btn gold small">Mint batch</button>
        <div id="batch-mint-msg" class="msg" style="display:none;"></div>
      </div>
    </div>

    <div id="panel-my-cars" class="panel">
      <div class="card">
        <h3>My racing cars</h3>
        <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.75rem;">NFTs you own. Use them to unlock stages (race director or keeper).</p>
        <div class="actions"><button type="button" id="btn-refresh-cars" class="btn gold small">Refresh</button></div>
        <ul id="my-cars-list" class="car-list"></ul>
        <div id="my-cars-empty" style="display:none; color: var(--text-dim); font-size: 0.9rem;">No cars yet. Mint one from the Mint car tab.</div>
      </div>
      <div class="card">
        <h4>Qualifying for stage 0</h4>
        <p id="qualifying-count" style="font-family: 'Share Tech Mono', monospace; color: var(--track);">—</p>
        <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 0.25rem;">Number of your cars that qualify for the first configured stage.</p>
      </div>
    </div>

    <div id="panel-progression" class="panel">
      <div class="card">
        <h3>My progression</h3>
        <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.75rem;">Stages unlocked and checkpoints reached (set by race director).</p>
        <div id="progression-content"></div>
      </div>
    </div>

    <div id="panel-leaderboard" class="panel">
      <div class="card">
        <h3>Stage leaders</h3>
        <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.75rem;">Best lap time per stage.</p>
        <div class="actions"><button type="button" id="btn-refresh-leaderboard" class="btn gold small">Refresh</button></div>
        <table class="leaderboard-table" id="leaderboard-table">
          <thead><tr><th>Stage</th><th>Leader</th><th>Best lap (ms)</th></tr></thead>
          <tbody id="leaderboard-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-roles" class="panel">
      <div class="card">
        <h3>Unlock stage (Race Director)</h3>
        <p style="color: var(--text-dim); font-size: 0.84rem; margin-bottom: 0.6rem;">Unlock a stage for a driver using one of their qualifying token IDs.</p>
        <label>Driver address</label>
        <input type="text" id="unlock-driver" class="input" placeholder="0x..." />
        <label>Token ID (must be owned by driver and qualify for next stage)</label>
        <input type="text" id="unlock-tokenid" class="input" placeholder="1" />
        <button type="button" id="btn-unlock-stage" class="btn gold small">Unlock stage</button>
        <div id="unlock-stage-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Record lap (Race Director)</h3>
        <label>Driver address</label>
        <input type="text" id="lap-driver" class="input" placeholder="0x..." />
        <label>Token ID</label>
        <input type="text" id="lap-tokenid" class="input" placeholder="1" />
        <label>Stage ID</label>
        <input type="number" id="lap-stage" class="input" min="0" value="0" />
        <label>Lap time (ms)</label>
        <input type="text" id="lap-time" class="input" placeholder="120000" />
        <button type="button" id="btn-record-lap" class="btn gold small">Record lap</button>
        <div id="record-lap-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Reach checkpoint (Race Director)</h3>
        <label>Driver address</label>
        <input type="text" id="cp-driver" class="input" placeholder="0x..." />
        <label>Stage ID</label>
        <input type="number" id="cp-stage" class="input" min="0" value="0" />
        <label>Checkpoint index</label>
        <input type="number" id="cp-index" class="input" min="0" value="0" />
        <label>Lap time (ms)</label>
        <input type="text" id="cp-time" class="input" placeholder="120000" />
        <button type="button" id="btn-reach-cp" class="btn gold small">Reach checkpoint</button>
        <div id="reach-cp-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Withdraw proceeds (Pit Boss)</h3>
        <label>To address</label>
        <input type="text" id="withdraw-to" class="input" placeholder="0x..." />
        <label>Amount (wei)</label>
        <input type="text" id="withdraw-amount" class="input" placeholder="0" value="0" />
        <button type="button" id="btn-withdraw" class="btn primary small">Withdraw</button>
        <div id="withdraw-msg" class="msg" style="display:none;"></div>
      </div>
      <div class="card">
        <h3>Configure stage (Pit Boss)</h3>
        <p style="color: var(--text-dim); font-size: 0.84rem; margin-bottom: 0.6rem;">Set required min engine tier and chassis mask (bitmask) for a stage.</p>
        <label>Stage ID (0–23)</label>
        <input type="number" id="cfg-stage-id" class="input" min="0" max="23" value="0" />
        <label>Required min tier (0–7)</label>
        <input type="number" id="cfg-stage-tier" class="input" min="0" max="7" value="0" />
        <label>Required chassis mask (uint32, 0 = any)</label>
        <input type="text" id="cfg-stage-mask" class="input" placeholder="0" value="0" />
        <button type="button" id="btn-configure-stage" class="btn primary small">Configure stage</button>
        <div id="configure-stage-msg" class="msg" style="display:none;"></div>
      </div>
    </div>

    <div id="panel-config" class="panel">
      <div class="card">
        <h3>Contract config</h3>
        <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.75rem;">Reponator Driver immutable addresses and settings.</p>
        <div class="config-grid" id="config-grid"></div>
        <h4>Immutable</h4>
        <div class="config-grid">
          <div class="config-item"><span class="k">Pit Boss</span><div class="v" id="cfg-pitboss">—</div></div>
          <div class="config-item"><span class="k">Race Director</span><div class="v" id="cfg-director">—</div></div>
          <div class="config-item"><span class="k">Treasury</span><div class="v" id="cfg-treasury">—</div></div>
          <div class="config-item"><span class="k">Prize Vault</span><div class="v" id="cfg-prize">—</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 1.25rem;">
      <h3>Stages & checkpoints</h3>
      <p style="color: var(--text-dim); font-size: 0.86rem; margin-bottom: 0.6rem;">Stages are configured by the Pit Boss with a required minimum engine tier and optional chassis mask. Checkpoints have a max lap time. Only the Race Director can unlock stages (using a driver’s qualifying token) and record laps/checkpoints.</p>
      <div id="stages-list" style="color: var(--text-dim); font-size: 0.84rem;"></div>
    </div>
    <div class="card" style="margin-top: 1rem;">
      <h3>About Hefo World Tour</h3>
      <p style="color: var(--text-dim); font-size: 0.88rem; line-height: 1.55;">Hefo World Tour is the web interface for the Reponator Driver (RPD) contract. Mint racing car NFTs with chassis type (0–31) and engine tier (0–7). Progression is NFT-gated: hold a qualifying car to unlock stages; the race director records laps and checkpoints. Leaderboard tracks best lap per stage. Pit boss configures stages and mint prices; treasury receives proceeds.</p>
      <p style="color: var(--text-dim); font-size: 0.82rem; margin-top: 0.5rem;">Constants: RPD_MAX_SUPPLY 9999, RPD_MAX_STAGES 24, RPD_MAX_CHECKPOINTS_PER_STAGE 16, RPD_BATCH_MINT_CAP 12, RPD_LAP_TIME_SCALE_MS 999999. Safe for EVM mainnets when deployed with verified role addresses.</p>
      <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 0.4rem;">Immutable addresses: Pit Boss, Race Director, Treasury, Prize Vault. No upgrade path; deploy a new contract to change roles.</p>
    </div>
    <p class="footer-note">Hefo World Tour · Reponator Driver (RPD) · Not financial advice.</p>
  </div>

  <script>
    (function () {
      const RPD_PIT_BOSS = '0x4B2c6E8f0A3d5F7b9C1e4F6a8B0d2E5f7A9c1D4e6';
      const RPD_RACE_DIRECTOR = '0x5C3d7F9a1B4e6D8f0A2c5E7b9D1f3A6c8E0b2D5f7';
      const RPD_TREASURY = '0x6D4e8F0a2B5c7E9d1F3a6C8e0B2d5F7a9C1e4D6f8';
      const RPD_PRIZE_VAULT = '0x7E5f9A1b3C6d8F0a2B5e7D9f1A4c6E8b0D2f5A7c9';
      let provider = null;
      let signer = null;
      let userAddress = null;
      let contractAddress = null;

      const contractIn = document.getElementById('contract-address');
      const walletEl = document.getElementById('wallet-addr');
      const statMinted = document.getElementById('stat-minted');
      const statMyCars = document.getElementById('stat-my-cars');
      const statStages = document.getElementById('stat-stages');
      const statPaused = document.getElementById('stat-paused');

      function showMsg(id, text, type) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text;
        el.className = 'msg ' + (type || 'info');
        el.style.display = 'block';
      }
      function hideMsg(id) { const el = document.getElementById(id); if (el) el.style.display = 'none'; }
      function getContractAddr() { return (contractIn.value || '').trim() || contractAddress; }

      async function connectWallet() {
        try {
          if (!window.ethereum) { showMsg('mint-msg', 'No Ethereum provider.', 'err'); return; }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          if (accounts.length) {
            userAddress = accounts[0];
            walletEl.textContent = userAddress.slice(0, 6) + '…' + userAddress.slice(-4);
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            if (contractIn.value.trim()) contractAddress = contractIn.value.trim();
            await refreshStats();
          }
        } catch (e) { showMsg('mint-msg', e.message || 'Connect failed', 'err'); }
      }

      async function refreshStats() {
        const addr = getContractAddr();
        if (!addr) {
          statMinted.textContent = '—';
          statMyCars.textContent = '—';
          statStages.textContent = '—';
          statPaused.textContent = '—';
          return;
        }
        try {
          const abi = [
            'function getFrontendConfig() view returns (address pitBoss_, address raceDirector_, uint256 totalMinted_, uint256 treasuryBalance_, bool paused_, uint256 deployBlock_)',
            'function balanceOf(address) view returns (uint256)',
            'function getStagesUnlockedCount(address) view returns (uint256)'
          ];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const cfg = await c.getFrontendConfig();
          statMinted.textContent = cfg.totalMinted_.toString();
          statPaused.textContent = cfg.paused_ ? 'Paused' : 'Active';
          if (userAddress) {
            const bal = await c.balanceOf(userAddress);
            statMyCars.textContent = bal.toString();
            const stages = await c.getStagesUnlockedCount(userAddress);
            statStages.textContent = stages.toString();
          } else {
            statMyCars.textContent = '—';
            statStages.textContent = '—';
          }
        } catch (e) {
          statMinted.textContent = '—';
          statMyCars.textContent = '—';
          statStages.textContent = '—';
          statPaused.textContent = '—';
        }
      }

      async function updateMintPriceDisplay() {
        const addr = getContractAddr();
        const chassis = parseInt(document.getElementById('mint-chassis').value, 10) || 0;
        const el = document.getElementById('mint-price-display');
        if (!addr) { el.placeholder = 'Set contract'; return; }
        try {
          const abi = ['function getMintPrice(uint8) view returns (uint256)'];
          const c = new ethers.Contract(addr, abi, provider || ethers.getDefaultProvider());
          const price = await c.getMintPrice(chassis);
          el.placeholder = price.toString() + ' wei';
        } catch (_) { el.placeholder = '—'; }
      }

      function renderMyCars(cars) {
        const list = document.getElementById('my-cars-list');
        const empty = document.getElementById('my-cars-empty');
        list.innerHTML = '';
        if (!cars || cars.length === 0) { empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        cars.forEach(function (c) {
          const li = document.createElement('li');
          li.innerHTML = '<span class="id">#' + c.tokenId + '</span><span class="traits">Chassis ' + c.chassis + ' · Tier ' + c.engineTier + '</span>';
          list.appendChild(li);
        });
      }

      async function loadMyCars() {
        const addr = getContractAddr();
        if (!addr || !userAddress) { renderMyCars([]); return; }
        try {
          const abi = [
            'function getCarsByOwner(address) view returns (uint256[] tokenIds)',
            'function getCarsTraits(uint256[]) view returns (uint8[] chassisTypes, uint8[] engineTiers, uint256[] mintBlocks)'
          ];
